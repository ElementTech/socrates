<!-- 
<div class="">
  <mat-toolbar class="d-flex justify-content-center">
    <i class="fa-solid fa-cubes" aria-hidden="true"></i> <h1 style="margin-right: 1em;">&nbsp;Instances</h1>
</mat-toolbar>
  <div class="example-header">
      <mat-form-field>
        <input matInput (keyup)="applyFilter($event.target.value)" placeholder="Filter" [(ngModel)]="this.dataSource.filter">
      </mat-form-field>
    </div>
    
    <div class="example-container mat-elevation-z8">
      <mat-paginator [showFirstLastButtons]="true" [pageSize]="10" [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
      <mat-table [dataSource]="dataSource" matSort>

        <ng-container matColumnDef="name">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Name</mat-header-cell>
          <mat-cell *matCellDef="let row"><img width="50px" [src]="this.imageUrls[row.image]">
            <a class="nav-link" style="cursor: pointer;" (click)="openDialog(row.desc)">{{row.name}}</a>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="run" >
          <mat-header-cell *matHeaderCellDef>Run</mat-header-cell>
          <mat-cell *matCellDef="let row" [style.color]="row.run">
            <mat-chip-list class="d-flex">
              <mat-button-toggle-group multiple vertical="false">
              <button mat-mini-fab style="margin-left:5px" color="primary" [routerLink]="['/instance-run/', row._id]"><i class="fa-solid fa-play" aria-hidden="true"></i></button>
              <img *ngIf="row.lastrun == false" matListAvatar src="../../../assets/success.png">
              <img *ngIf="row.lastrun == true" matListAvatar src="../../../assets/fail.png">
              <img *ngIf="row.lastrun == 'running'" width="50" matListAvatar src="../../../assets/loading.gif">
              <img *ngIf="row.lastrun == 'none'" matListAvatar src="../../../assets/question.png">
              <mat-chip class="flex-fill">{{row.numruns}}</mat-chip>
            </mat-button-toggle-group>
            </mat-chip-list>
          </mat-cell>
        </ng-container>


        <ng-container matColumnDef="desc">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Description</mat-header-cell>
          <mat-cell *matCellDef="let row" [style.color]="row.desc">{{row.desc}}</mat-cell>
        </ng-container>
        <ng-container matColumnDef="configure">
          <mat-header-cell *matHeaderCellDef>Configure</mat-header-cell>
          <mat-cell *matCellDef="let row" [style.color]="row.configure">
            <mat-button-toggle-group multiple vertical="false">
            <button mat-button [routerLink]="['/create-instance/', row._id]"><mat-icon aria-hidden="false" style="color:darkslateblue;">edit</mat-icon></button>
            <button mat-button (click)="removeInstance(row._id)"><mat-icon aria-hidden="false" style="color: maroon;">delete</mat-icon></button>
            <a [routerLink]="['/instance-stats/', row._id]" mat-button><i class="fa-solid fa-bar-chart" aria-hidden="true"></i></a>
          </mat-button-toggle-group>
          </mat-cell>
        </ng-container>
        <ng-container matColumnDef="block">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Block</mat-header-cell>
          <mat-cell *matCellDef="let row" [style.color]="row.block.name"><button mat-button color="primary" [routerLink]="['/create-block/', row.block._id]"><i class="fa-solid fa-edit" aria-hidden="true"></i>&nbsp;{{row.block.name}}</button></mat-cell>
        </ng-container>
        <ng-container matColumnDef="parameters">
          <mat-header-cell *matHeaderCellDef mat-sort-header>Values</mat-header-cell>
          <mat-cell *matCellDef="let row" [style.color]="row.parameters">   
          <mat-chip-list>

            <ng-container aria-label="Parameters" *ngIf='row.parameters.length != 0'>
            
                <mat-chip color="primary" selected *ngFor="let param of row.parameters">
                  <ng-container *ngIf="param.secret == true">
              
                    ***
                  </ng-container>
                  <ng-container *ngIf="param.secret == false">
              
                    {{param.value}}
                  </ng-container>
                </mat-chip>
            
            </ng-container>
            <ng-container aria-label="Parameters" *ngIf='row.shared.length != 0'>
              
                <mat-chip color="accent" selected *ngFor="let param of row.shared">
                  <ng-container *ngIf="param.secret == true">
                
                    ***
                  </ng-container>
                  <ng-container *ngIf="param.secret == false">
                 
                    {{param.value}}
                  </ng-container>
                </mat-chip>
            
            </ng-container>
            <ng-container aria-label="Parameters" *ngIf='row.parameters.length == 0 && row.shared.length == 0 && row.booleans.length == 0 && row.multis.length == 0'>
              <mat-chip>No Parameters</mat-chip>
            </ng-container>
            <ng-container aria-label="Parameters" *ngIf='row.booleans.length != 0'>
              <mat-chip color="primary" selected *ngFor="let param of row.booleans">
          
                {{param.value}}</mat-chip>
            </ng-container>
            <ng-container aria-label="Parameters" *ngIf='row.multis.length != 0'>
              <mat-chip color="primary" selected *ngFor="let param of row.multis">
        
                {{param.value}}</mat-chip>
            </ng-container>
          </mat-chip-list>
        </mat-cell>
        </ng-container>
        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row class="chosen-row" *matRowDef="let row; columns: displayedColumns;">
        </mat-row>
      </mat-table>
    
  
    </div>
</div> -->


<p-toast></p-toast>
<p-toolbar>
  <ng-template pTemplate="left">
      <button pButton pRipple label="New" icon="pi pi-plus" class="p-button-success mr-2" [routerLink]="'/create-instance'"></button>
      <button pButton pRipple [label]="Delete" icon="pi pi-trash" class="p-button-danger" (click)="deleteSelectedInstances()" [disabled]="!selectedInstances || !selectedInstances.length"></button>
  </ng-template>
  <h2>
    <i class="fa-solid fa-cubes"></i> List of Instances

  </h2>
  <!-- <ng-template pTemplate="right">
      <button pButton pRipple label="Export" icon="pi pi-upload" class="p-button-help"></button>
  </ng-template> -->
</p-toolbar>
<p-table 

#dt [value]="instances"  [(selection)]="selectedInstances" dataKey="_id" styleClass="p-datatable-sm p-datatable-gridlines" [rowHover]="true"
[rows]="10" [showCurrentPageReport]="true" [rowsPerPageOptions]="[10,25,50]" [loading]="loading" responsiveLayout="scroll"
[paginator]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
[filterDelay]="0" [globalFilterFields]="['name','lang','github']">
<ng-template pTemplate="caption">
    <div class="table-header">
          <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Global Search" />
          </span>
    </div>
</ng-template>

<ng-template pTemplate="header">
    <tr>
        <th  style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th  style="width: 3rem">
        </th>
        <th  style="width: 3rem">
          
      </th>
        <th  pSortableColumn="name">
            <div class="flex justify-content-between align-items-center">
                Name
                <p-sortIcon field="name"></p-sortIcon>
                <p-columnFilter type="text" field="name" display="menu" class="ml-auto"></p-columnFilter>
            </div>
        </th>
        <th  pSortableColumn="block">
          <div class="flex justify-content-between align-items-center">
              Block
              <p-sortIcon field="block"></p-sortIcon>
              <p-columnFilter type="text" field="block" display="menu" class="ml-auto"></p-columnFilter>
          </div>
      </th>
    
        <!-- <th pSortableColumn="lang">
            <div class="flex justify-content-between align-items-center">
                Language
                <p-sortIcon field="lang"></p-sortIcon>
                <p-columnFilter field="lang" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" class="ml-auto">
                  <ng-template pTemplate="header">
                      <div class="px-3 pt-3 pb-0">
                          <span class="font-bold">Language Picker</span>
                      </div>
                  </ng-template>
                  <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect [ngModel]="value" [options]="langs" placeholder="Any" (onChange)="filter($event?.value)" display="chip" [optionValue]="'value'" [optionLabel]="'id'">
                          <ng-template let-option pTemplate="item">
                              <div class="p-multiselect-instance-option">
                                  <img [alt]="option" onerror="this.src='../../../assets/no_code.png'"  style="vertical-align: middle" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/{{option.value | lowercase}}/{{option.value | lowercase}}-original.svg" width="32">
                                  <span class="ml-1">{{option.value}}</span>
                              </div>
                          </ng-template>
                      </p-multiSelect>
                  </ng-template>
              </p-columnFilter>
            </div>
        </th> -->


        <th  pSortableColumn="lastrun"  style="width: 10rem">
          <div class="flex justify-content-between align-items-center">
              Last Run
              <p-sortIcon field="lastrun"></p-sortIcon>
              <p-columnFilter [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" field="lastrun" matchMode="equals" display="menu" class="ml-auto">
                  <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-dropdown [ngModel]="value" [options]="lastRunOptions" (onChange)="filter($event.value)" placeholder="Any">
                          <ng-template let-option pTemplate="item">
                              <span [class]="'customer-badge lastrun-' + option">{{option}}</span>
                          </ng-template>
                      </p-dropdown>
                  </ng-template>
              </p-columnFilter>
          </div>
        </th>
        <th pSortableColumn="numruns">
          <div class="flex justify-content-between align-items-center">
              # Runs
              <p-sortIcon field="numruns"></p-sortIcon>
              <p-columnFilter type="numeric" field="numruns" display="menu" class="ml-auto"></p-columnFilter>
          </div>
        </th>
        <!-- <th pSortableColumn="activity">
            <div class="flex justify-content-between align-items-center">
                Activity
                <p-sortIcon field="activity"></p-sortIcon>
                <p-columnFilter field="activity" matchMode="between" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" class="ml-auto">
                    <ng-template pTemplate="filter" let-filter="filterCallback">
                        <p-slider [ngModel]="activityValues" [range]="true" (onSlideEnd)="filter($event.values)" styleClass="m-3"></p-slider>
                        <div class="flex align-items-center justify-content-between px-2">
                            <span>{{activityValues[0]}}</span>
                            <span>{{activityValues[1]}}</span>
                        </div>
                    </ng-template>
                </p-columnFilter>
            </div>
        </th> -->
        <th >
          <div class="flex justify-content-between align-items-center">
            Parameters
          </div>
        </th>
        <th pSortableColumn="createdAt">
          <div class="flex justify-content-between align-items-center">
              Created
              <p-sortIcon field="createdAt"></p-sortIcon>
              <!-- <p-columnFilter type="date" field="createdAt" display="menu" class="ml-auto"></p-columnFilter> -->
              
          </div>
      </th>
      <th pSortableColumn="updatedAt">
          <div class="flex justify-content-between align-items-center">
              Updated
              <p-sortIcon field="updatedAt"></p-sortIcon>
              <!-- <p-columnFilter type="date" field="updatedAt" display="menu" class="ml-auto"></p-columnFilter> -->
          </div>
      </th>
        <th></th>

    </tr>
</ng-template>
<ng-template pTemplate="body" let-instance  let-expanded="expanded">
    <tr class="p-selectable-row">
        <td>
            <p-tableCheckbox [value]="instance"></p-tableCheckbox>
        </td>
        <td>
          <button  style="height:30px;width: 30px;" [routerLink]="['/instance-run/', instance._id]" pButton pRipple type="button" icon="pi pi-play" class="p-button-rounded p-button-sm"></button>
        </td>
        <td>
          <button  *ngIf="instance.desc" style="height:30px;width: 30px;" type="button" pButton pRipple [pRowToggler]="instance" class="p-button-text p-button-sm p-button-rounded p-button-plain" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
        </td>
        <td>
            <span class="p-column-title">Name</span>
            <img width="30px" [src]="this.imageUrls[instance.image]">
            {{instance.name}}
        </td>
        <td>
          <span class="p-column-title">Block</span>
          {{instance.block}}
        </td>
      
        <!-- <td>
            <span class="p-column-title">Lang</span>
            <img onerror="this.src='../../../assets/no_code.png'" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/{{instance.lang | lowercase}}/{{instance.lang | lowercase}}-original.svg" width="30">
            <span class="image-text">{{instance.lang}}</span>
        </td> -->
      
        <!-- <td>
            {{instance.balance | currency:'USD':'symbol'}}
        </td> -->
        <td>
            <span class="p-column-title">Last Build</span>
            <img  style="height:30px;width: 30px;" *ngIf="instance.lastrun == true" matListAvatar src="../../../assets/success.png">
            <img  style="height:30px;width: 30px;" *ngIf="instance.lastrun == false" matListAvatar src="../../../assets/fail.png">
            <img  style="height:30px;width: 30px;" *ngIf="instance.lastrun == 'running'" width="50" matListAvatar src="../../../assets/loading.gif">
            <img  style="height:30px;width: 30px;" *ngIf="instance.lastrun == 'none'" matListAvatar src="../../../assets/question.png">
        </td>
        <td>
          {{instance.numruns}}
        </td>
        <td>
          <ng-container *ngFor="let param of instance.parameters.concat(instance.shared).concat(instance.shared).concat(instance.multis).concat(instance.booleans)">
            <p-tag *ngIf="param.key && !param.secret" [style.margin-right]="'.5rem'" value="{{param.key}}={{param.value}}"></p-tag>
            <p-tag *ngIf="param.key && param.secret" [style.margin-right]="'.5rem'" value="{{param.key}}=****"></p-tag>
          </ng-container>
        </td>
        <!-- <td>
            <span class="p-column-title">Activity</span>
            <p-progressBar [value]="instance.activity" [showValue]="false"></p-progressBar>
        </td> -->
        <td>
          {{instance.createdAt | date:'short'}}
        </td>
        <td>
          {{instance.updatedAt | date:'short'}}
        </td>
        <td style="text-align: center">
    

            <button pButton pRipple style="height:30px;width: 30px;" pTooltip="Edit" tooltipPosition="top" [routerLink]="['/create-instance/', instance._id]" class="p-button-rounded  p-button-info" icon="pi pi-cog"></button>
            <button pButton pRipple class="p-button" style="height:30px;width: 70px;" pTooltip="Flows Attached to this Instance" tooltipPosition="top"  [routerLink]="['/flow-list/']"><i class="fa-solid fa-stairs" aria-hidden="true"></i> <p-badge [value]="instance.flow_count" severity="primary" [style.margin-right]="'1em'"></p-badge></button>
            <button pButton pRipple class="p-button" style="height:30px;width: 70px;" pTooltip="Flows Attached to this Instance" tooltipPosition="top"  [routerLink]="['/flow-viz-list/']"><i class="fa-solid fa-diagram-project" aria-hidden="true"></i> <p-badge [value]="instance.flowviz_count" severity="primary" [style.margin-right]="'1em'"></p-badge></button>
            <button pButton pRipple style="height:30px;width: 30px;" pTooltip="Statistics"  tooltipPosition="top"  [routerLink]="['/instance-stats/', instance._id]"  class="p-button-rounded p-button-secondary" icon="pi pi-chart-line"></button>

        </td>

    </tr>
</ng-template>
<ng-template pTemplate="rowexpansion" let-instance>
  <tr>
    <td colspan="20">
      {{instance.desc}}

    </td>
  </tr>
</ng-template>
<ng-template pTemplate="emptymessage">
    <tr>
        <td colspan="20">No instances found.</td>
    </tr>
</ng-template>
</p-table>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
